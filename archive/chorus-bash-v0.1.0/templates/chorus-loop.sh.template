#!/usr/bin/env bash
# Chorus Loop - Ralph Wiggum pattern runner
# This script runs an autonomous loop until task completion
#
# Usage: ./scripts/chorus-loop.sh "task description" [max-iterations]

set -euo pipefail

TASK="${1:-}"
MAX_ITERATIONS="${2:-20}"
PROGRESS_FILE=".agent/progress.txt"

if [[ -z "$TASK" ]]; then
    echo "Usage: $0 \"task description\" [max-iterations]"
    echo ""
    echo "Example:"
    echo "  $0 \"Implement user authentication\" 10"
    exit 1
fi

# Ensure progress file exists
mkdir -p .agent
touch "$PROGRESS_FILE"

echo "Starting Chorus Loop"
echo "Task: $TASK"
echo "Max iterations: $MAX_ITERATIONS"
echo ""

iteration=0
while [[ $iteration -lt $MAX_ITERATIONS ]]; do
    ((iteration++))

    # Log iteration start
    echo "" >> "$PROGRESS_FILE"
    echo "=== Iteration $iteration ($(date '+%Y-%m-%d %H:%M')) ===" >> "$PROGRESS_FILE"
    echo "Task: $TASK" >> "$PROGRESS_FILE"

    echo "--- Iteration $iteration ---"

    # Run Claude with the task
    # The Stop hook will check completion criteria
    claude --dangerously-skip-permissions -p "$TASK

Check .agent/progress.txt for previous iterations.
When task is complete, write 'STATUS: DONE' to .agent/progress.txt.
If blocked, write 'STATUS: BLOCKED' with reason."

    # Check if done
    if grep -q "STATUS: DONE" "$PROGRESS_FILE"; then
        echo ""
        echo "✓ Task completed after $iteration iterations"
        exit 0
    fi

    # Check if blocked
    if grep -q "STATUS: BLOCKED" "$PROGRESS_FILE"; then
        echo ""
        echo "⚠ Task blocked - check .agent/progress.txt for details"
        exit 1
    fi

    echo ""
done

echo "Max iterations reached ($MAX_ITERATIONS)"
echo "Task may not be complete - check .agent/progress.txt"
exit 1
